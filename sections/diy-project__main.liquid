{%- liquid
  assign project_title = ''
  assign project_sku = ''
  assign project_description = ''
  assign project_image = null
  assign skill_level = ''
  assign product_handle = ''
  assign category_handle = ''
  assign category_title = ''
  
  if metaobject != blank
    assign project_title = metaobject.display_name
    
    if metaobject.fields != blank
      for field in metaobject.fields
        case field.key
          when 'title'
            assign project_title = field.value
          when 'sku'
            assign project_sku = field.value
          when 'description'
            assign project_description = field.value
          when 'image'
            if field.reference
              assign project_image = field.reference.image | default: field.reference
            endif
          when 'skill_level'
            assign skill_level = field.value
          when 'product_handle'
            if field.reference
              assign product_handle = field.reference.handle
            else
              assign product_handle = field.value
            endif
          when 'category'
            if field.reference
              assign category_handle = field.reference.handle
              assign category_title = field.reference.display_name
              if category_title == blank
                for cat_field in field.reference.fields
                  if cat_field.key == 'title'
                    assign category_title = cat_field.value
                    break
                  endif
                endfor
              endif
            endif
        endcase
      endfor
    endif
  endif
  
  if project_title == blank
    if metaobject != blank
      assign project_title = metaobject.handle | replace: '-', ' ' | capitalize
    else
      assign project_title = 'DIY Project'
    endif
  endif
-%}

<div class="container">
  {%- assign project_handle = metaobject.handle | default: '' -%}
  {%- if project_handle == blank -%}
    {%- assign path_parts = request.path | split: '/' -%}
    {%- if path_parts[1] == 'pages' and path_parts[2] == 'diy-projects' -%}
      {%- assign project_handle = path_parts[3] -%}
    {%- elsif path_parts[1] == 'metaobjects' and path_parts[2] == 'diy_projects' -%}
      {%- assign project_handle = path_parts[3] -%}
    {%- endif -%}
  {%- endif -%}

  <div vue-init v-cloak>
    <diy-project-detail
      inline-template
      :metaobject="{% if metaobject %}{{ metaobject | json | escape }}{% else %}{}{% endif %}"
      project-handle="{{ project_handle }}"
      product-handle="{{ product_handle }}"
      category-handle="{{ category_handle }}"
      category-title="{{ category_title }}">
      
      <div class="diy-project-detail">
        <div v-if="isLoading" class="text-center py-12">
          <p class="lead">{{ 'general.misc.loading' | t }}</p>
          <div class="loading-animation">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
          </div>
        </div>

        <div v-else-if="error" class="text-center py-12">
          <p class="text-error">${ error }</p>
          <p class="text-sm text-gray-600 mt-2">Please try refreshing the page.</p>
        </div>

        <template v-else>
          <div class="w-full gap-8 md:grid grid-cols-[35%_1fr] mb-8">
            <div class="relative">
              <div v-if="projectImage" class="image-gallery">
                <responsive-image
                  :src="projectImage"
                  :base-width="1000"
                  :base-height="1000"
                  sizes="(max-width: 767px) 100vw, (max-width: 1440px) 35vw, calc(1440px * 0.35)"
                  :alt="projectTitle"
                  class="w-full">
                </responsive-image>
              </div>
              <div v-else class="image-gallery">
                {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
              </div>
            </div>
            
            <div class="project-info">
              <h3 class="mb-3">${ projectTitle || '{{ project_title }}' }</h3>
              
              <div class="breadcrumb-wrapper uppercase flex items-center mb-5 text-[10px] leading-[1.4]">
                {% render 'breadcrumbs', category_title: category_title, category_handle: category_handle %}
              </div>
              
              <div class="flex gap-4 mb-4 pb-4 border-b border-gray-300 diy-project-buttons">
                <button 
                  @click="scrollToSupplies"
                  class="button button--primary flex items-center gap-2 diy-project-btn">
                  {% render 'icon', name: 'cart' %}
                  VIEW SUPPLY LIST
                </button>
                <button 
                  @click="printProject"
                  class="button button--primary flex items-center gap-2 diy-project-btn">
                  {% render 'icon', name: 'print' %}
                  PRINT PROJECT
                </button>
              </div>
              
              <div v-if="projectSku || '{{ project_sku }}'" class="mb-4 text-sm text-gray-600">
                ITEM: ${ projectSku || '{{ project_sku }}' }
              </div>
              
              <div v-if="projectDescription || '{{ project_description }}'" class="mb-6" v-html="projectDescription || '{{ project_description }}'"></div>
              
              <div v-if="skillLevel || '{{ skill_level }}'" class="mb-6">
                <a href="/pages/ki-skill-levels" class="skill-level-badge">Skill Level: ${ skillLevel || '{{ skill_level }}' }</a>
              </div>
              
              <div class="flex items-center gap-4">
                {% render 'social-sharing', 
                  share_permalink: request.path,
                  share_title: project_title,
                  share_image: project_image %}
              </div>
            </div>
          </div>
          
          <section class="supplies-section" id="supplies">
          <div class="supplies-header mb-6">
            <h2 class="h3">Supplies</h2>
            <div class="mt-4">
              <button 
                v-if="bundledProducts && bundledProducts.length > 0"
                @click="addAllBundledProductsToCart"
                :disabled="isAddingAll"
                class="button button--primary"
                :class="{ 'opacity-50 cursor-not-allowed': isAddingAll }">
                <span v-if="isAddingAll">Adding...</span>
                <span v-else>ADD ALL MATERIALS TO CART</span>
              </button>
              <button 
                v-else-if="productHandle || product"
                @click="addProductToCart"
                :disabled="isAddingProduct || isAddingToCart"
                class="button button--primary"
                :class="{ 'opacity-50 cursor-not-allowed': isAddingProduct || isAddingToCart }">
                <span v-if="isAddingProduct || isAddingToCart">Adding...</span>
                <span v-else>ADD ALL MATERIALS TO CART</span>
              </button>
            </div>
          </div>
          
          <div v-if="bundledProducts && bundledProducts.length > 0" class="bundled-products-container">
            <div class="supplies-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div v-for="bundledProduct in bundledProducts" :key="bundledProduct.id || bundledProduct.handle" class="bundled-product-item">
                <div class="bundled-product-wrapper relative">
                  <product-item
                    inline-template
                    :product="bundledProduct"
                    :featured-media="bundledProduct.featured_media"
                    :url="'/products/' + bundledProduct.handle"
                    :custom-quantity="productQuantities[bundledProduct.id] || bundledProduct.bundle_quantity || 1"
                    :on-add-to-cart="(productId, qty) => addProductToPendingCart(productId, qty)"
                    :show-quantity-selector="true"
                    :quantity-value="productQuantities[bundledProduct.id] || bundledProduct.bundle_quantity || 1"
                    :on-quantity-update="(qty) => updateProductQuantity(bundledProduct.id, qty)"
                    :show-stock-status="true"
                    img-sizes="(max-width: 767px) 50vw, (max-width: 1440px) 25vw, calc(1440px / 4)">
                    {% render 'product-item' %}
                  </product-item>
                  <div v-if="pendingCartItems && pendingCartItems[bundledProduct.id] && pendingCartItems[bundledProduct.id] > 0" class="pending-cart-badge">
                    x ${ pendingCartItems[bundledProduct.id] } in cart
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div v-if="bundledProducts && bundledProducts.length > 0" class="supplies-footer mt-6">
            <button 
              @click="addAllBundledProductsToCart"
              :disabled="isAddingAll"
              class="button button--primary"
              :class="{ 'opacity-50 cursor-not-allowed': isAddingAll }">
              <span v-if="isAddingAll">Adding...</span>
              <span v-else>ADD ALL MATERIALS TO CART</span>
            </button>
          </div>
          
          <div v-else-if="productHandle || product" class="product-container">
            <div v-if="product" class="supplies-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <product-item
                inline-template
                :product="product"
                :featured-media="product.featured_media"
                :url="'/products/' + (productHandle || product.handle)"
                img-sizes="(max-width: 767px) 50vw, (max-width: 1440px) 25vw, calc(1440px / 4)">
                {% render 'product-item' %}
              </product-item>
            </div>
            <div v-else class="text-center py-8">
              <p class="text-gray-600">Loading product...</p>
            </div>
          </div>
          
          <div v-if="productHandle || product" v-show="!bundledProducts || bundledProducts.length === 0" class="supplies-footer mt-6">
            <button 
              @click="addProductToCart"
              :disabled="isAddingProduct || isAddingToCart"
              class="button button--primary"
              :class="{ 'opacity-50 cursor-not-allowed': isAddingProduct || isAddingToCart }">
              <span v-if="isAddingProduct || isAddingToCart">Adding...</span>
              <span v-else>ADD ALL MATERIALS TO CART</span>
            </button>
          </div>
          
          <div v-else class="text-center py-8">
            <p class="text-gray-600">No supplies available for this project.</p>
          </div>
        </section>
        </template>
      </div>
    </diy-project-detail>
  </div>
</div>

{% schema %}
{
  "name": "DIY Project Main",
  "tag": "section",
  "settings": []
}
{% endschema %}

